<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iPhone PWAè¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="åŸå®¿TIC">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/480/suitcase.png">

    <title>åŸå®¿TIC Baggage Service (Local)</title>
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Dexie.js (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª) -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&family=Noto+Sans+JP:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ãƒªã‚»ãƒƒãƒˆã¨åŸºæœ¬è¨­å®š --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
            background-color: #0f172a; /* ãƒ€ãƒ¼ã‚¯èƒŒæ™¯ */
            color: #f8fafc;
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
            height: 100vh;
        }

        /* --- ã‚¬ãƒ©ã‚±ãƒ¼é¢¨ãƒ»3Dãƒœã‚¿ãƒ³ --- */
        .btn-3d {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            border: none;
            border-radius: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
            text-align: center;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3); 
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.3) !important;
        }

        .color-blue { background-color: #3b82f6; box-shadow: 0 6px 0 #1d4ed8; color: white; }
        .color-blue:active { box-shadow: 0 2px 0 #1d4ed8 !important; }

        .color-green { background-color: #10b981; box-shadow: 0 6px 0 #047857; color: white; }
        .color-green:active { box-shadow: 0 2px 0 #047857 !important; }

        .color-red { background-color: #ef4444; box-shadow: 0 6px 0 #b91c1c; color: white; }
        .color-red:active { box-shadow: 0 2px 0 #b91c1c !important; }

        .color-gray { background-color: #64748b; box-shadow: 0 6px 0 #334155; color: white; }
        .color-gray:active { box-shadow: 0 2px 0 #334155 !important; }

        .color-orange { background-color: #f59e0b; box-shadow: 0 6px 0 #b45309; color: white; }
        .color-orange:active { box-shadow: 0 2px 0 #b45309 !important; }

        .color-dark { background-color: #1e293b; box-shadow: 0 6px 0 #0f172a; color: #94a3b8; }
        .color-dark:active { box-shadow: 0 2px 0 #0f172a !important; }

        /* --- ã‚«ãƒ¼ãƒ‰ --- */
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            color: #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* --- ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
        .input-display {
            background-color: #f1f5f9;
            border: 3px solid #cbd5e1;
            border-radius: 12px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            color: #2563eb;
            width: 100%;
            cursor: pointer;
        }

        /* --- ãƒ†ãƒ³ã‚­ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        #keypad-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.98); 
            z-index: 9999;
            display: none; 
            flex-direction: column;
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            flex-grow: 1;
            max-height: 500px;
        }

        .key-btn {
            height: 100%;
            min-height: 70px;
            font-size: 32px;
            border-radius: 12px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto min-h-screen flex flex-col p-4">
        
        <!-- ================= TOP PAGE ================= -->
        <section id="view-home" class="flex flex-col gap-6 w-full">
            <header class="text-center py-4">
                <h1 class="text-3xl italic text-blue-400 tracking-tighter" style="font-family: 'Poppins';">TIC HARAJUKU</h1>
                <p class="text-xs font-bold tracking-[0.4em] text-slate-500 uppercase mt-1">Local Mode</p>
            </header>

            <nav class="w-full flex flex-col gap-4">
                <button onclick="nav('intake')" class="btn-3d color-blue py-8">
                    <span class="text-4xl mb-1">ğŸ§³</span>
                    <span class="text-2xl">é ã‹ã‚‹</span>
                </button>
                <div class="grid grid-cols-2 gap-4 w-full">
                    <button onclick="nav('return')" class="btn-3d color-green py-6">
                        <span class="text-3xl mb-1">ğŸ”‘</span>
                        <span class="text-lg">è¿”å´</span>
                    </button>
                    <button onclick="nav('check')" class="btn-3d color-gray py-6">
                        <span class="text-3xl mb-1">ğŸ“Š</span>
                        <span class="text-lg">ç¢ºèª</span>
                    </button>
                </div>
            </nav>

            <div class="grid grid-cols-2 gap-4 mt-2">
                <div class="card flex flex-col items-center justify-center border-b-4 border-slate-300">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">æœ¬æ—¥ç·æ•°</p>
                    <div class="flex items-baseline gap-1">
                        <span id="stat-total" class="text-4xl font-black text-slate-700">0</span>
                        <span class="text-xs text-slate-400 font-bold">çµ„</span>
                    </div>
                </div>
                <div class="card flex flex-col items-center justify-center border-b-4 border-blue-500">
                    <p class="text-[10px] font-bold text-blue-500 uppercase">ç¾åœ¨ä¿ç®¡ä¸­</p>
                    <div class="flex items-baseline gap-1">
                        <span id="stat-held" class="text-4xl font-black text-blue-600">0</span>
                        <span class="text-xs text-blue-400 font-bold">çµ„</span>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-8 text-center pb-4">
                <button onclick="app.exportCSV()" class="text-slate-500 text-xs font-bold underline bg-transparent border-none">
                    æ—¥è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ› (CSV)
                </button>
                <p class="text-[9px] text-slate-600 mt-2">â€»ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</p>
            </div>
        </section>

        <!-- ================= INTAKE PAGE ================= -->
        <section id="view-intake" class="hidden flex-col gap-4 w-full h-full">
            <div class="flex items-center gap-4">
                <button onclick="nav('home')" class="btn-3d color-dark py-3 px-4 text-sm" style="width: auto;">â† TOP</button>
                <h2 class="text-xl font-bold text-white">è·ç‰©ã‚’é ã‹ã‚‹</h2>
            </div>

            <div class="card flex flex-col gap-5">
                <div id="cam-trigger" onclick="document.getElementById('file-input').click()" class="w-full aspect-video bg-slate-100 rounded-xl border-4 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer overflow-hidden relative">
                    <span class="text-4xl mb-2">ğŸ“¸</span>
                    <p class="font-bold text-sm">å†™çœŸã‚’æ’®å½±</p>
                    <img id="preview-img" class="hidden absolute inset-0 w-full h-full object-cover">
                </div>
                <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden" onchange="app.handleFile(this)">

                <div class="flex flex-col gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">ç•ªå·æœ­ No.</label>
                        <div id="display-tag" onclick="openKeypad('tag')" class="input-display">---</div>
                        <input type="hidden" id="val-tag">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">å€‹æ•°</label>
                            <div id="display-count" onclick="openKeypad('count')" class="input-display">1</div>
                            <input type="hidden" id="val-count" value="1">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">æˆ»ã‚Šäºˆå®š</label>
                            <select id="val-time" class="w-full h-[70px] bg-slate-100 border-2 border-slate-200 rounded-xl px-2 text-xl font-bold text-center text-slate-700 outline-none">
                                <!-- JSã§é¸æŠè‚¢ç”Ÿæˆ -->
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">å‚™è€ƒ</label>
                        <textarea id="val-notes" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 text-base text-slate-700 outline-none" rows="2" placeholder="ä¾‹: èµ¤ã„ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹"></textarea>
                    </div>
                </div>

                <button id="btn-save" onclick="app.save()" class="btn-3d color-blue py-6 text-xl mt-2">
                    ç¢ºå®šã—ã¦ç™»éŒ²
                </button>
            </div>
        </section>

        <!-- ================= RETURN PAGE ================= -->
        <section id="view-return" class="hidden flex-col gap-4 w-full h-full">
            <div class="flex items-center gap-4">
                <button onclick="nav('home')" class="btn-3d color-dark py-3 px-4 text-sm" style="width: auto;">â† TOP</button>
                <h2 class="text-xl font-bold text-white">è·ç‰©ã‚’è¿”ã™</h2>
            </div>

            <div class="card flex flex-col gap-6 min-h-[60vh]">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">è¿”å´ã™ã‚‹ç•ªå·ã‚’å…¥åŠ›</label>
                    <div id="display-search" onclick="openKeypad('search')" class="input-display text-green-600 border-green-200 bg-green-50">ç•ªå·å…¥åŠ›</div>
                    <input type="hidden" id="val-search">
                </div>

                <div id="search-result" class="hidden flex-col gap-4 animate-fade-in"></div>
                <div id="no-result" class="flex-grow flex items-center justify-center text-slate-400 font-bold italic py-10">
                    ç•ªå·ã‚’é¸æŠã—ã¦ãã ã•ã„
                </div>
            </div>
        </section>

        <!-- ================= CHECK PAGE ================= -->
        <section id="view-check" class="hidden flex-col gap-4 w-full h-full">
            <div class="flex items-center gap-4">
                <button onclick="nav('home')" class="btn-3d color-dark py-3 px-4 text-sm" style="width: auto;">â† TOP</button>
                <h2 class="text-xl font-bold text-white">ä¿ç®¡çŠ¶æ³</h2>
            </div>

            <div class="card">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 text-center tracking-widest">è¿”å´ãƒ”ãƒ¼ã‚¯äºˆæ¸¬</h3>
                <canvas id="peakChart" height="150"></canvas>
            </div>

            <div id="held-list" class="flex flex-col gap-3 pb-10"></div>
        </section>

    </div>

    <!-- ================= ãƒ†ãƒ³ã‚­ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« ================= -->
    <div id="keypad-overlay">
        <div class="max-w-md mx-auto w-full h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 px-1">
                <button onclick="closeKeypad(false)" class="btn-3d color-gray py-2 px-4 text-sm" style="width:auto;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <h3 id="keypad-title" class="text-xl font-black text-blue-400 tracking-wider">ç•ªå·ã‚’å…¥åŠ›</h3>
                <div class="w-20"></div>
            </div>

            <div id="keypad-screen" class="bg-white text-slate-900 rounded-2xl h-24 flex items-center justify-center text-6xl font-black mb-6 shadow-inner border-4 border-blue-500">
                0
            </div>

            <div class="keypad-grid mb-4">
                <button onclick="keyIn('1')" class="btn-3d color-blue key-btn">1</button>
                <button onclick="keyIn('2')" class="btn-3d color-blue key-btn">2</button>
                <button onclick="keyIn('3')" class="btn-3d color-blue key-btn">3</button>
                <button onclick="keyIn('4')" class="btn-3d color-blue key-btn">4</button>
                <button onclick="keyIn('5')" class="btn-3d color-blue key-btn">5</button>
                <button onclick="keyIn('6')" class="btn-3d color-blue key-btn">6</button>
                <button onclick="keyIn('7')" class="btn-3d color-blue key-btn">7</button>
                <button onclick="keyIn('8')" class="btn-3d color-blue key-btn">8</button>
                <button onclick="keyIn('9')" class="btn-3d color-blue key-btn">9</button>
                <button onclick="keyIn('ac')" class="btn-3d color-red key-btn text-xl">AC</button>
                <button onclick="keyIn('0')" class="btn-3d color-blue key-btn">0</button>
                <button onclick="keyIn('back')" class="btn-3d color-orange key-btn text-xl">â†</button>
            </div>

            <button onclick="closeKeypad(true)" class="btn-3d color-green py-6 text-2xl mb-4">
                ç¢º å®š (OK)
            </button>
        </div>
    </div>

    <!-- ================= ãƒ­ã‚¸ãƒƒã‚¯ (IndexedDBä½¿ç”¨) ================= -->
    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š (Dexie.js) ---
        const db = new Dexie("TicBaggageDB");
        db.version(1).stores({
            logs: "++id, tag, status, createdAt, returnTime" // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        });

        let currentKeyTarget = null;
        let currentKeyVal = "";
        let chart = null;
        let currentPhotoBase64 = null;

        // --- åˆæœŸåŒ– ---
        window.onload = async () => {
            // æ™‚é–“é¸æŠè‚¢
            const timeSel = document.getElementById('val-time');
            for (let h = 10; h <= 21; h++) {
                for (let m of ['00', '30']) {
                    const t = `${h.toString().padStart(2, '0')}:${m}`;
                    const opt = document.createElement('option');
                    opt.value = t; opt.textContent = t;
                    timeSel.appendChild(opt);
                }
            }
            // æœŸé™åˆ‡ã‚Œãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ (3æ—¥ä»¥ä¸Šå‰)
            await cleanupOldData();
            updateDashboard();
        };

        async function cleanupOldData() {
            const threeDaysAgo = new Date().getTime() - (3 * 24 * 60 * 60 * 1000);
            await db.logs.where('createdAt').below(threeDaysAgo).delete();
        }

        // --- ç”»é¢é·ç§» ---
        window.nav = (viewId) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            if (viewId === 'check') renderChart();
            window.scrollTo(0,0);
        };

        // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–° ---
        async function updateDashboard() {
            const todayStart = new Date();
            todayStart.setHours(0,0,0,0);
            
            const allLogs = await db.logs.toArray();
            const todayLogs = allLogs.filter(l => l.createdAt >= todayStart.getTime());
            const held = allLogs.filter(l => l.status === 'held');

            document.getElementById('stat-total').innerText = todayLogs.length;
            document.getElementById('stat-held').innerText = held.length;

            const list = document.getElementById('held-list');
            list.innerHTML = "";
            
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            held.sort((a,b) => b.createdAt - a.createdAt).forEach(l => {
                const item = document.createElement('div');
                item.className = "card flex items-center gap-4 py-3 cursor-pointer active:bg-slate-50 transition-all border-l-8 border-blue-500 mb-2";
                item.onclick = () => {
                    nav('return');
                    document.getElementById('val-search').value = l.tag;
                    document.getElementById('display-search').innerText = l.tag;
                    searchBag(l.tag);
                };
                item.innerHTML = `
                    <img src="${l.image || 'https://via.placeholder.com/100?text=No+Img'}" class="w-16 h-16 rounded-xl object-cover bg-slate-100 border border-slate-200">
                    <div class="flex-1">
                        <p class="font-black text-2xl text-slate-700">No.${l.tag}</p>
                        <p class="text-xs font-bold text-blue-600">â° ${l.returnTime} æˆ»ã‚Š (${l.count}å€‹)</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- ãƒ†ãƒ³ã‚­ãƒ¼åˆ¶å¾¡ ---
        window.openKeypad = (type) => {
            currentKeyTarget = type;
            const titles = { 'tag': 'ç•ªå·æœ­ã‚’å…¥åŠ›', 'count': 'å€‹æ•°ã‚’å…¥åŠ›', 'search': 'è¿”å´ç•ªå·ã‚’å…¥åŠ›' };
            document.getElementById('keypad-title').innerText = titles[type];
            currentKeyVal = document.getElementById('val-' + type).value || "";
            document.getElementById('keypad-screen').innerText = currentKeyVal || "0";
            document.getElementById('keypad-overlay').style.display = 'flex';
        };

        window.keyIn = (v) => {
            if (v === 'ac') currentKeyVal = "";
            else if (v === 'back') currentKeyVal = currentKeyVal.slice(0, -1);
            else if (currentKeyVal.length < 5) currentKeyVal += v;
            document.getElementById('keypad-screen').innerText = currentKeyVal || "0";
        };

        window.closeKeypad = (save) => {
            if (save && currentKeyTarget) {
                document.getElementById('val-' + currentKeyTarget).value = currentKeyVal;
                document.getElementById('display-' + currentKeyTarget).innerText = currentKeyVal || (currentKeyTarget === 'count' ? '1' : '---');
                if (currentKeyTarget === 'search') searchBag(currentKeyVal);
            }
            document.getElementById('keypad-overlay').style.display = 'none';
        };

        // --- å†™çœŸå‡¦ç† (ç¸®å°ã—ã¦Base64åŒ–) ---
        window.app = window.app || {};
        window.app.handleFile = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // ç”»åƒç¸®å°å‡¦ç† (iPhoneã®é«˜ç”»è³ªå¯¾ç­–)
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7); // åœ§ç¸®
                    const preview = document.getElementById('preview-img');
                    preview.src = currentPhotoBase64;
                    preview.classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- ä¿å­˜ (Intake) ---
        window.app.save = async () => {
            const tag = document.getElementById('val-tag').value;
            if (!tag || !currentPhotoBase64) return alert("ç•ªå·æœ­ã¨å†™çœŸã¯å¿…é ˆã§ã™ï¼");

            const btn = document.getElementById('btn-save');
            const originalText = btn.innerText;
            btn.innerText = "ä¿å­˜ä¸­..."; btn.disabled = true;

            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«DBã«ä¿å­˜
                await db.logs.add({
                    tag: tag,
                    count: document.getElementById('val-count').value || "1",
                    returnTime: document.getElementById('val-time').value,
                    notes: document.getElementById('val-notes').value,
                    image: currentPhotoBase64,
                    status: 'held',
                    createdAt: new Date().getTime()
                });

                alert("ç™»éŒ²å®Œäº†ï¼");
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('val-tag').value = '';
                document.getElementById('display-tag').innerText = '---';
                document.getElementById('preview-img').classList.add('hidden');
                currentPhotoBase64 = null;
                
                updateDashboard();
                nav('home');
            } catch (e) {
                console.error(e);
                alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                btn.disabled = false; btn.innerText = originalText;
            }
        };

        // --- æ¤œç´¢ (Return) ---
        async function searchBag(num) {
            const resBox = document.getElementById('search-result');
            const noRes = document.getElementById('no-result');
            
            // DBæ¤œç´¢
            const found = await db.logs.where('tag').equals(num).filter(l => l.status === 'held').toArray();

            if (found.length === 0) {
                resBox.classList.add('hidden');
                noRes.classList.remove('hidden');
                noRes.innerText = "è©²å½“ãªã—";
                return;
            }

            noRes.classList.add('hidden');
            resBox.classList.remove('hidden');
            resBox.innerHTML = "";
            
            found.forEach(l => {
                const div = document.createElement('div');
                div.className = "animate-fade-in";
                div.innerHTML = `
                    <img src="${l.image}" class="w-full rounded-2xl mb-4 border-2 border-slate-100 shadow-lg">
                    <p class="text-4xl font-black text-slate-800">No.${l.tag}</p>
                    <p class="text-xl font-bold text-slate-500 mb-2">${l.count} å€‹</p>
                    <p class="text-blue-600 font-black text-2xl mb-4 italic">â° ${l.returnTime} æˆ»ã‚Š</p>
                    <div class="bg-blue-50 p-4 rounded-xl mb-6 text-sm text-slate-600 border border-blue-100">
                        <b>å‚™è€ƒ:</b> ${l.notes || 'ãªã—'}
                    </div>
                    <button onclick="confirmReturn(${l.id})" class="btn-3d color-green py-6 text-2xl">
                        è¿”å´ã‚’å®Œäº†ã™ã‚‹
                    </button>
                `;
                resBox.appendChild(div);
            });
        }

        window.confirmReturn = async (id) => {
            if (!confirm("è¿”å´æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await db.logs.update(id, { status: 'returned', returnedAt: new Date().getTime() });
            alert("è¿”å´å®Œäº†ï¼");
            updateDashboard();
            nav('home');
        };

        // --- ã‚°ãƒ©ãƒ• (Check) ---
        async function renderChart() {
            const ctx = document.getElementById('peakChart').getContext('2d');
            const labels = ["10:00", "12:00", "14:00", "16:00", "18:00", "20:00"];
            
            const allHeld = await db.logs.where('status').equals('held').toArray();
            
            const dataValues = labels.map(t => {
                const h = parseInt(t.split(':')[0]);
                return allHeld.filter(l => {
                    if (!l.returnTime) return false;
                    const itemH = parseInt(l.returnTime.split(':')[0]);
                    return itemH >= h && itemH < h + 2;
                }).length;
            });

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'æˆ»ã‚Šäºˆå®š', data: dataValues, backgroundColor: '#3b82f6', borderRadius: 6 }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } }
                }
            });
        }

        // --- CSVå‡ºåŠ› ---
        window.app.exportCSV = async () => {
            const allLogs = await db.logs.toArray();
            if (allLogs.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            
            const rows = [["Tag", "Count", "ReturnTime", "Status", "RegisteredAt"]];
            allLogs.forEach(l => {
                const d = new Date(l.createdAt).toLocaleString('ja-JP');
                rows.push([l.tag, l.count, l.returnTime, l.status, d]);
            });
            
            const csv = "\uFEFF" + rows.map(r => r.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `TIC_Local_Data_${new Date().toLocaleDateString()}.csv`; a.click();
        };
    </script>
</body>
</html>